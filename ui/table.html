<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Machine Editor</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            line-height: 1.4;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: #1a1a1a;
            color: #00ff00;
            border: 1px solid #333;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
        }

        .btn:hover {
            background: #2a2a2a;
        }

        .btn.danger {
            color: #ff6b6b;
        }

        .btn.primary {
            color: #00ffff;
        }

        .view-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }

        .tab {
            background: #1a1a1a;
            color: #666;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            font-family: inherit;
        }

        .tab.active {
            background: #2a2a2a;
            color: #00ff00;
        }

        .editing {
            border: 2px solid #00ff00 !important;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            background: rgba(0, 255, 0, 0.05) !important;
        }

        .editing-child {
            background: rgba(0, 255, 0, 0.02) !important;
        }

        /* Table Grid Style */
        .table-view table {
            width: 100%;
            border-collapse: collapse;
            background: #0f0f0f;
        }

        .table-view th {
            background: #333;
            color: #fff;
            padding: 10px;
            border: 1px solid #555;
            text-align: left;
        }

        .table-view td {
            padding: 8px;
            border: 1px solid #333;
            vertical-align: top;
        }

        .editable {
            background: transparent;
            border: none;
            border-bottom: 1px solid #333;
            color: inherit;
            font-family: inherit;
            font-size: inherit;
            padding: 2px 4px;
            border-radius: 0;
            width: 100%;
        }

        .editable:focus {
            background: #222;
            border-bottom-color: #00ff00;
            outline: none;
        }

        .state-id {
            color: #00ffff;
            font-weight: bold;
        }

        .action-select {
            background: #1a1a1a;
            color: #90ee90;
            border: none;
            border-bottom: 1px solid #333;
            padding: 2px;
            font-family: inherit;
        }

        .action-select:focus {
            border-bottom-color: #00ff00;
            outline: none;
        }

        .condition-item {
            margin-bottom: 5px;
            padding: 3px 6px;
            background: #222;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .condition-select {
            background: #1a1a1a;
            color: #ffff00;
            border: none;
            border-bottom: 1px solid #333;
            padding: 2px;
            font-family: inherit;
            font-size: 11px;
        }

        .condition-select:focus {
            border-bottom-color: #00ff00;
            outline: none;
        }

        .next-state-select {
            background: #1a1a1a;
            color: #ff69b4;
            border: none;
            border-bottom: 1px solid #333;
            padding: 2px;
            font-family: inherit;
            font-size: 11px;
        }

        .next-state-select:focus {
            border-bottom-color: #00ff00;
            outline: none;
        }

        .add-transition {
            background: #1a3a1a;
            color: #00ff00;
            border: 1px solid #333;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 10px;
            border-radius: 2px;
        }

        .remove-transition {
            background: #3a1a1a;
            color: #ff6b6b;
            border: 1px solid #333;
            padding: 1px 4px;
            cursor: pointer;
            font-size: 10px;
            border-radius: 2px;
        }

        /* Flow Chart Style */
        .flow-view {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .flow-node {
            background: #2a2a3a;
            border: 2px solid #4a4a5a;
            border-radius: 10px;
            padding: 15px;
            min-width: 250px;
            position: relative;
        }

        .flow-node .state-header {
            color: #00ffff;
            font-weight: bold;
            border-bottom: 1px solid #666;
            padding-bottom: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .flow-node .transitions {
            font-size: 0.9em;
        }

        .flow-node .transition {
            margin: 5px 0;
            padding: 3px;
            background: #1a1a2a;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* JSON Style */
        .json-view {
            background: #001100;
            white-space: pre;
            font-family: 'Fira Code', monospace;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
        }

        .json-key {
            color: #79b6f2;
        }

        .json-string {
            color: #a3be8c;
        }

        .json-number {
            color: #d08770;
        }

        .json-bracket {
            color: #eceff4;
        }

        .alias-input {
            background: #1a1a1a;
            color: #666;
            border: 1px solid #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
        }

        .status {
            color: #666;
            font-size: 12px;
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .status.saving {
            background-color: #1a1a2a;
            color: #00ffff;
            border: 1px solid #00ffff;
        }

        .status.saving::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #00cccc);
            animation: savingProgress 2s ease-in-out forwards;
        }

        .status.saved {
            background-color: #1a3a1a;
            color: #00ff00;
            border: 1px solid #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            animation: savedPulse 0.5s ease-in-out;
        }

        @keyframes savedPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @keyframes savingProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .status.error {
            background-color: #3a1a1a;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }

        .hidden {
            display: none;
        }

        .selector-input {
            background: #1a1a1a;
            color: #ffa500;
            border: none;
            border-bottom: 1px solid #333;
            padding: 2px;
            font-family: inherit;
            font-size: 11px;
            width: 100%;
            margin-top: 2px;
        }

        .selector-input:focus {
            border-bottom-color: #00ff00;
            outline: none;
        }

        .value-input {
            background: #1a1a1a;
            color: #ffa500;
            border: none;
            border-bottom: 1px solid #333;
            padding: 2px;
            font-family: inherit;
            font-size: 11px;
        }

        .value-input:focus {
            border-bottom-color: #00ff00;
            outline: none;
        }

        .optional-input {
            background: #1a1a1a;
            color: #ff69b4;
            border: none;
            border-bottom: 1px solid #333;
            padding: 2px;
            font-family: inherit;
            font-size: 10px;
            margin-left: 5px;
            width: 80px;
        }

        .optional-input:focus {
            border-bottom-color: #00ff00;
            outline: none;
        }
    </style>
</head>

<body>
    <!-- Modal overlay for creating new bot - moved outside the container -->
    <div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
        <div id="new-bot-form" style="display:flex; flex-direction:column; align-items:center; background:#111; padding:30px; border-radius:16px; color:#fff; width:400px; position:relative;">
            <button id="close-modal" style="position:absolute; top:10px; right:15px; background:none; border:none; color:#fff; font-size:20px; cursor:pointer;">√ó</button>
            <h2>Create New Bot</h2>
            <input id="bot-name" placeholder="Bot Name" style="margin:8px 0; width:100%; padding:12px; border-radius:8px; border:none;"/>
            <input id="start-url" placeholder="Start URL" style="margin:8px 0; width:100%; padding:12px; border-radius:8px; border:none;"/>
            <button id="create-bot-btn" style="margin-top:16px; padding:12px 24px; border:none; border-radius:8px; cursor:pointer; background:#0f0; color:#000; font-weight:bold;">Create Bot</button>
        </div>
    </div>

    <div id="bot-selection-container" style="display:flex; flex-wrap:wrap; gap:20px; justify-content:center; padding:40px; background-color:#000; min-height:100vh;">
    </div>

    <div class="header">
        <div>
            <h1>ü§ñ STATE MACHINE EDITOR</h1>
            <input type="text" class="alias-input" id="botAlias" placeholder="Bot Name">
        </div>
        <div class="controls">
            <button class="btn" onclick="addState()">‚ûï Add State</button>
            <button class="btn" onclick="manualSave()">üíæ Save Bot</button>
            <button class="btn" id="runBotBtn" onclick="runBot()" style="display: none;">‚ñ∂Ô∏è Run Bot</button>
            <button class="btn danger" id="stopBotBtn" onclick="stopBot()" style="display: none;">‚èπÔ∏è Stop Bot</button>
            <button class="btn" id="pauseBotBtn" onclick="pauseBot()" style="display: none;">‚è∏Ô∏è Pause</button>
            <button class="btn" id="resumeBotBtn" onclick="resumeBot()" style="display: none;">‚ñ∂Ô∏è Resume</button>
            <button class="btn danger" id="deleteBotBtn" onclick="deleteCurrentBot()" style="display: none;">üóëÔ∏è Delete Bot</button>
        </div>
    </div>

    <select id="botSelect" style="display: none;">
        <!-- Bot options will be populated dynamically -->
    </select>

    <div class="view-tabs">
        <button class="tab active" onclick="switchView('table', event)">TABLE GRID</button>
        <button class="tab" onclick="switchView('flow', event)">FLOW NODES</button>
    </div>

    <div id="tableView" class="table-view">
        <table>
            <thead>
                <tr>
                    <th>INDEX</th>
                    <th>ACTION</th>
                    <th>VALUE</th>
                    <th>SELECTORS</th>
                    <th>CONDITIONS ‚Üí TRANSITIONS</th>
                    <th>ACTIONS</th>
                </tr>
            </thead>
            <tbody id="statesTable">
                <!-- Dynamic content -->
            </tbody>
        </table>
    </div>

    <div id="flowView" class="flow-view" style="display: none;">
        <!-- Dynamic flow nodes -->
    </div>

    <div class="status" id="status">Ready ‚Ä¢ Select a bot to start editing</div>

    <!-- Import the API functions -->
    <script type="module">
        import {
            fetchBots,
            fetchBot,
            loadBotFile,
            saveBot,
            deleteBot,
            startBotAPI,
            stopBotAPI,
            pauseBotAPI,
            resumeBotAPI,
            fetchActions,
            fetchConditions
        } from './api.js';

        // Make API functions available globally
        window.apiModule = {
            fetchBots,
            fetchBot,
            loadBotFile,
            saveBot,
            deleteBot,
            startBotAPI,
            stopBotAPI,
            pauseBotAPI,
            resumeBotAPI,
            fetchActions,
            fetchConditions
        };

        // Also make individual functions available globally for backward compatibility
        window.startBotAPI = startBotAPI;
        window.stopBotAPI = stopBotAPI;
        window.pauseBotAPI = pauseBotAPI;
        window.resumeBotAPI = resumeBotAPI;
        window.deleteBot = deleteBot;

        console.log('API module loaded successfully:', window.apiModule);

        // Initialize the page after the module loads
        window.initializePage();
    </script>

    <script>
        function slugifyName(name) {
            return name
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, "_")
                .replace(/^_+|_+$/g, "")
                .replace(/_{2,}/g, "_");
        }

        async function createNewBot() {
            console.log("create new button");
            const botNameField = document.getElementById("bot-name");
            const startUrlField = document.getElementById("start-url");

            const rawName = (botNameField?.value || "").trim();
            const startUrl = (startUrlField?.value || "").trim();
            if (!rawName || !startUrl) return alert("Please enter bot name and start URL");

            const slug = slugifyName(rawName);
            const fileName = `${slug}.json`;

            const newBot = {
                bot_name: rawName,
                start_url: startUrl,
                states: [],
                file_name: fileName
            };

            try {
                const result = await window.apiModule.saveBot(newBot);
                if (result.error) return alert(result.error);

                botNameField.value = '';
                startUrlField.value = '';
                closeModal();

                await loadBots(); // Refresh the bot list

                alert(`${rawName} created! Click its card to start editing.`);
            } catch (err) {
                console.error("Error creating bot:", err);
                alert("Network error. Failed to create bot.");
            }
        }

        function showModal() {
            const modalOverlay = document.getElementById("modal-overlay");
            if (modalOverlay) {
                modalOverlay.style.display = "flex";
            } else {
                console.error("Modal overlay element not found");
                alert("Error: Modal not found. Please refresh the page.");
            }
        }

        function closeModal() {
            document.getElementById("modal-overlay").style.display = "none";
            // Reset form
            document.getElementById("bot-name").value = '';
            document.getElementById("start-url").value = '';
        }

        // Setup event handlers when DOM is ready
        function setupEventHandlers() {
            const createBtn = document.getElementById("create-bot-btn");
            const closeBtn = document.getElementById("close-modal");
            const modalOverlay = document.getElementById("modal-overlay");
            const botAliasInput = document.getElementById('botAlias');

            if (createBtn) createBtn.onclick = createNewBot;
            if (closeBtn) closeBtn.onclick = closeModal;
            
            // Close modal when clicking overlay
            if (modalOverlay) {
                modalOverlay.onclick = function(e) {
                    if (e.target === this) {
                        closeModal();
                    }
                };
            }

            // Auto-save bot name changes
            if (botAliasInput) {
                botAliasInput.addEventListener('input', function() {
                    autoSave();
                });
            }
        }

        async function loadBots() {
            const container = document.getElementById('bot-selection-container');
            container.innerHTML = ''; // Clear previous

            try {
                const bots = await window.apiModule.fetchBots();

                bots.forEach(bot => {
                    const card = document.createElement('div');
                    card.style.cssText = `
                      background-color:#111; 
                      color:#fff; 
                      width:250px; 
                      height:300px; 
                      border-radius:16px; 
                      display:flex; 
                      flex-direction:column; 
                      align-items:center; 
                      justify-content:flex-start; 
                      padding:16px; 
                      cursor:pointer;
                      box-shadow:0 0 20px rgba(0,0,0,0.7);
                      transition: transform 0.2s;
                    `;
                    card.onmouseover = () => card.style.transform = 'scale(1.05)';
                    card.onmouseout = () => card.style.transform = 'scale(1)';
                    card.onclick = () => loadBotForEditing(bot.file);

                    const img = document.createElement('img');
                    img.src = bot.bot_image || 'https://via.placeholder.com/150';
                    img.style.cssText = 'width:100%; height:120px; object-fit:cover; border-radius:8px;';
                    card.appendChild(img);

                    const title = document.createElement('h2');
                    title.textContent = bot.bot_name;
                    title.style.cssText = 'margin:12px 0 4px 0; font-size:20px; text-align:center;';
                    card.appendChild(title);

                    const file = document.createElement('div');
                    file.textContent = bot.file_name;
                    file.style.cssText = 'font-size:14px; color:#aaa; text-align:center;';
                    card.appendChild(file);

                    const desc = document.createElement('p');
                    desc.textContent = bot.bot_description || 'No description';
                    desc.style.cssText = 'font-size:12px; color:#ccc; margin-top:8px; text-align:center; flex-grow:1;';
                    card.appendChild(desc);

                    container.appendChild(card);
                });

                // Add "New Bot" card
                const addCard = document.createElement('div');
                addCard.style.cssText = `
                    background-color:#111; 
                    color:#fff; 
                    width:250px; 
                    height:300px; 
                    border-radius:16px; 
                    display:flex; 
                    align-items:center; 
                    justify-content:center; 
                    font-size:48px; 
                    cursor:pointer; 
                    box-shadow:0 0 20px rgba(0,0,0,0.7);
                    transition: transform 0.2s;
                `;
                addCard.textContent = '+';
                addCard.onmouseover = () => addCard.style.transform = 'scale(1.05)';
                addCard.onmouseout = () => addCard.style.transform = 'scale(1)';
                addCard.onclick = () => {
                    showModal();
                };
                container.appendChild(addCard);
            } catch (error) {
                console.error('Error loading bots:', error);
                updateStatus('Error loading bots');
            }
        }

        async function loadBotForEditing(fileName) {
            try {
                const bot = await window.apiModule.loadBotFile(fileName);
                stateData = bot;
                document.getElementById('botAlias').value = stateData.bot_name || '';
                backfillAliases(); // Add aliases to old JSONs
                editingStateId = null;
                
                // Hide bot selection and show editor
                document.getElementById('bot-selection-container').style.display = 'none';
                document.querySelector('.header').style.display = 'flex';
                document.querySelector('.view-tabs').style.display = 'flex';
                document.getElementById('tableView').style.display = 'block';
                document.getElementById('status').style.display = 'block';
                
                // Show bot control buttons
                updateBotControlButtons();
                
                renderCurrentView();
                updateStatus(`Loaded ${stateData.states.length} states from ${fileName}`);
            } catch (error) {
                console.error('Error loading bot:', error);
                updateStatus(`Error loading bot: ${error.message}`);
            }
        }

        // Initialize page with bot selection view
        function initializePage() {
            // Hide editor elements initially
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.view-tabs').style.display = 'none';
            document.getElementById('tableView').style.display = 'none';
            document.getElementById('flowView').style.display = 'none';
            document.getElementById('status').style.display = 'none';
            
            // Setup event handlers
            setupEventHandlers();
            
            // Load bots
            loadBots();
        }

        // Make initializePage available globally and don't auto-call it
        window.initializePage = initializePage;

        let stateData = {
            bot_name: "",
            start_url: "",
            states: [],
            file_name: ""
        };

        let botStatus = 'stopped'; // 'stopped', 'running', 'paused'

        let currentView = 'table';
        let stateIndex = 0;
        let editingStateId = null;
        let clickCount = {};

        let actionTypes = [
            'do_nothing', 'fill', 'click', 'navigate_to', 'press_enter',
            'wait', 'scroll', 'hover', 'select', 'clear', 'type'
        ];

        let conditionTypes = [
            'element_exists', 'url_matches', 'always', 'wait_for_element',
            'text_contains', 'element_visible', 'element_clickable', 'timeout'
        ];

        // Load action and condition types from API
        async function loadActionAndConditionTypes() {
            try {
                const [actions, conditions] = await Promise.all([
                    window.apiModule.fetchActions(),
                    window.apiModule.fetchConditions()
                ]);
                
                if (actions && actions.length > 0) {
                    actionTypes = actions;
                }
                if (conditions && conditions.length > 0) {
                    conditionTypes = conditions;
                }
            } catch (error) {
                console.log('Using default action and condition types');
            }
        }

        // Load action/condition types on startup
        loadActionAndConditionTypes();

        function getStateAlias(stateId) {
            const state = stateData.states.find(s => s.id === stateId);
            if (!state) return stateId;
            return state.alias || `${state.action}_${stateId.split('_').pop().slice(-4)}`;
        }

        function getStateByAlias(alias) {
            return stateData.states.find(s => getStateAlias(s.id) === alias);
        }

        function getAllStateAliases() {
            return stateData.states.map(s => getStateAlias(s.id));
        }

        function setEditingState(stateId) {
            editingStateId = stateId;
            renderCurrentView();
        }

        function updateStateAlias(stateIndex, newAlias) {
            const oldAlias = getStateAlias(stateData.states[stateIndex].id);
            stateData.states[stateIndex].alias = newAlias;

            // Update all references to this alias in transitions
            stateData.states.forEach(state => {
                state.transitions.forEach(transition => {
                    if (transition.next === oldAlias || transition.next === stateData.states[stateIndex].id) {
                        transition.next = newAlias;
                    }
                });
            });

            renderCurrentView();
            autoSave(); // Trigger auto-save when alias changes
        }

        function backfillAliases() {
            stateData.states.forEach(state => {
                if (!state.alias) {
                    state.alias = `${state.action}_${state.id.split('_').pop().slice(-4)}`;
                }
            });
        }

        function updateStatus(msg, type = 'normal') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = msg;
            
            console.log('updateStatus called:', msg, type); // Debug log
            
            // Remove existing classes
            statusElement.classList.remove('saved', 'error', 'saving');
            
            // Add appropriate class based on type
            if (type === 'saved') {
                statusElement.classList.add('saved');
                console.log('Added saved class'); // Debug log
                // Remove the saved class after 3 seconds
                setTimeout(() => {
                    statusElement.classList.remove('saved');
                }, 3000);
            } else if (type === 'error') {
                statusElement.classList.add('error');
                console.log('Added error class'); // Debug log
                // Remove the error class after 5 seconds
                setTimeout(() => {
                    statusElement.classList.remove('error');
                }, 5000);
            } else if (type === 'saving') {
                statusElement.classList.add('saving');
                console.log('Added saving class'); // Debug log
            }
        }

        function generateStateId() {
            return `state_${Date.now()}`;
        }

        async function loadBotFromList() {
            try {
                const bots = await window.apiModule.fetchBots();
                const botSelect = document.getElementById('botSelect');
                botSelect.innerHTML = '';
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select a bot...';
                botSelect.appendChild(defaultOption);
                
                bots.forEach(bot => {
                    const option = document.createElement('option');
                    option.value = bot.file;
                    option.textContent = `${bot.bot_name} (${bot.file})`;
                    botSelect.appendChild(option);
                });
                
                botSelect.style.display = 'block';
                botSelect.onchange = async (e) => {
                    if (e.target.value) {
                        await loadBotForEditing(e.target.value);
                        botSelect.style.display = 'none';
                    }
                };
            } catch (error) {
                console.error('Error loading bot list:', error);
                updateStatus('Error loading bot list');
            }
        }

        function addState() {
            const newState = {
                id: generateStateId(),
                alias: '',
                action: 'do_nothing',
                selectors: [],
                transitions: [],
                value: ''
            };
            stateData.states.push(newState);
            renderCurrentView();
            updateStatus('Added new state');
            
            // Auto-save after adding state
            autoSave();
            
            // Scroll to bottom
            setTimeout(() => {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        // Auto-save functionality
        let autoSaveTimeout;
        async function autoSave() {
            if (!stateData.file_name) {
                console.log('Auto-save skipped: no file_name');
                return; // Don't auto-save if no file loaded
            }
            
            console.log('Auto-save triggered for file:', stateData.file_name);
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
                try {
                    // Show saving progress with percentage
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += 10;
                        if (progress <= 90) {
                            updateStatus(`Saving... ${progress}%`, 'saving');
                        }
                    }, 200);
                    
                    stateData.bot_name = document.getElementById('botAlias').value || 'bot';
                    console.log('Auto-saving bot:', stateData);
                    const result = await window.apiModule.saveBot(stateData);
                    
                    clearInterval(progressInterval);
                    updateStatus('Saving... 100%', 'saving');
                    
                    // Small delay to show 100% before success
                    setTimeout(() => {
                        if (!result.error) {
                            updateStatus('Auto-saved ‚úì', 'saved');
                            console.log('Auto-save successful');
                        } else {
                            updateStatus(`Auto-save failed: ${result.error}`, 'error');
                            console.error('Auto-save error:', result.error);
                        }
                    }, 200);
                } catch (error) {
                    console.error('Auto-save failed:', error);
                    updateStatus(`Auto-save failed: ${error.message}`, 'error');
                }
            }, 1000); // Wait 1 second after last change
        }

        // Manual save function
        async function manualSave() {
            if (!stateData.file_name) {
                alert('Please save the bot first before making changes.');
                return;
            }
            
            try {
                // Show saving progress with percentage
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        updateStatus(`Saving... ${progress}%`, 'saving');
                    }
                }, 200);
                
                stateData.bot_name = document.getElementById('botAlias').value || 'bot';
                console.log('Manually saving bot:', stateData);
                const result = await window.apiModule.saveBot(stateData);
                
                clearInterval(progressInterval);
                updateStatus('Saving... 100%', 'saving');
                
                // Small delay to show 100% before success
                setTimeout(() => {
                    if (!result.error) {
                        updateStatus('Bot saved successfully ‚úì', 'saved');
                    } else {
                        updateStatus(`Save failed: ${result.error}`, 'error');
                        console.error('Save error:', result.error);
                    }
                }, 200);
            } catch (error) {
                console.error('Manual save failed:', error);
                updateStatus(`Save failed: ${error.message}`, 'error');
            }
        }

        function removeState(index) {
            if (confirm('Delete this state?')) {
                stateData.states.splice(index, 1);
                renderCurrentView();
                updateStatus('State deleted');
                autoSave(); // Trigger auto-save when state is deleted
            }
        }

        function addTransition(stateIndex) {
            const newTransition = {
                condition: 'always',
                next: 'pause',
                conditional_parameter: ''
            };
            stateData.states[stateIndex].transitions.push(newTransition);
            renderCurrentView();
            autoSave(); // Trigger auto-save when transition is added
        }

        function removeTransition(stateIndex, transitionIndex) {
            stateData.states[stateIndex].transitions.splice(transitionIndex, 1);
            renderCurrentView();
            autoSave(); // Trigger auto-save when transition is removed
        }

        function updateStateProperty(stateIndex, property, value) {
            stateData.states[stateIndex][property] = value;
            if (currentView === 'json') renderCurrentView();
            autoSave(); // Trigger auto-save when state properties change
        }

        function updateTransitionProperty(stateIndex, transitionIndex, property, value) {
            if (property === 'next' && value !== 'pause') {
                // Convert alias back to state ID
                const targetState = getStateByAlias(value);
                if (targetState) {
                    value = targetState.id;
                }
            }
            stateData.states[stateIndex].transitions[transitionIndex][property] = value;
            autoSave(); // Trigger auto-save when transition properties change
        }

        function switchView(view, evt) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (evt) evt.target.classList.add('active');

            // Hide all views
            document.getElementById('tableView').style.display = 'none';
            document.getElementById('flowView').style.display = 'none';

            // Show selected view
            if (view === 'table') {
                document.getElementById('tableView').style.display = 'block';
            } else if (view === 'flow') {
                document.getElementById('flowView').style.display = 'flex';
            }
            
            currentView = view;
            renderCurrentView();
        }

        function renderCurrentView() {
            switch (currentView) {
                case 'table':
                    renderTableView();
                    break;
                case 'flow':
                    renderFlowView();
                    break;
            }
        }

        function handleStateClick(e, stateId) {
            e.stopPropagation();
            
            // Initialize click count for this state
            if (!clickCount[stateId]) {
                clickCount[stateId] = 0;
            }
            
            clickCount[stateId]++;
            
            // Single click - set as editing state
            if (clickCount[stateId] === 1) {
                setTimeout(() => {
                    if (clickCount[stateId] === 1) {
                        setEditingState(stateId);
                    }
                    clickCount[stateId] = 0;
                }, 300);
            }
        }

        function renderTableView() {
            const tbody = document.getElementById('statesTable');
            tbody.innerHTML = '';

            stateData.states.forEach((state, index) => {
                const row = document.createElement('tr');
                if (editingStateId === state.id) {
                    row.classList.add('editing');
                }

                // Add row click to set editing - improved event handling
                row.onclick = (e) => handleStateClick(e, state.id);
                row.style.cursor = 'pointer';

                // Alias (editable)
                const aliasCell = document.createElement('td');
                const aliasInput = document.createElement('input');
                aliasInput.className = 'editable';
                aliasInput.value = getStateAlias(state.id);
                aliasInput.onclick = (e) => e.stopPropagation(); // Prevent row click
                aliasInput.onchange = (e) => updateStateAlias(index, e.target.value);
                aliasCell.appendChild(aliasInput);
                row.appendChild(aliasCell);

                // Action
                const actionCell = document.createElement('td');
                const actionSelect = document.createElement('select');
                actionSelect.className = 'action-select';
                actionTypes.forEach(action => {
                    const option = document.createElement('option');
                    option.value = action;
                    option.textContent = action;
                    if (action === state.action) option.selected = true;
                    actionSelect.appendChild(option);
                });
                actionSelect.onclick = (e) => e.stopPropagation(); // Prevent row click
                actionSelect.onchange = (e) => updateStateProperty(index, 'action', e.target.value);
                actionCell.appendChild(actionSelect);
                row.appendChild(actionCell);

                // Value
                const valueCell = document.createElement('td');
                const valueInput = document.createElement('input');
                valueInput.className = 'value-input';
                valueInput.value = state.value || '';
                valueInput.onclick = (e) => e.stopPropagation(); // Prevent row click
                valueInput.onchange = (e) => updateStateProperty(index, 'value', e.target.value);
                valueCell.appendChild(valueInput);
                row.appendChild(valueCell);

                // Selectors
                const selectorsCell = document.createElement('td');
                const selectorsTextarea = document.createElement('textarea');
                selectorsTextarea.className = 'selector-input';
                selectorsTextarea.value = (state.selectors || []).join('\n');
                selectorsTextarea.rows = 2;
                selectorsTextarea.onclick = (e) => e.stopPropagation(); // Prevent row click
                selectorsTextarea.onchange = (e) => {
                    const selectors = e.target.value.split('\n').filter(s => s.trim());
                    updateStateProperty(index, 'selectors', selectors);
                };
                selectorsCell.appendChild(selectorsTextarea);
                row.appendChild(selectorsCell);

                // Transitions
                const transitionsCell = document.createElement('td');
                state.transitions.forEach((transition, tIndex) => {
                    const transitionDiv = document.createElement('div');
                    transitionDiv.className = 'condition-item';

                    const conditionSelect = document.createElement('select');
                    conditionSelect.className = 'condition-select';
                    conditionTypes.forEach(condition => {
                        const option = document.createElement('option');
                        option.value = condition;
                        option.textContent = condition;
                        if (condition === transition.condition) option.selected = true;
                        conditionSelect.appendChild(option);
                    });
                    conditionSelect.onclick = (e) => e.stopPropagation(); // Prevent row click
                    conditionSelect.onchange = (e) => updateTransitionProperty(index, tIndex, 'condition', e.target.value);

                    const arrow = document.createElement('span');
                    arrow.textContent = ' ‚Üí ';
                    arrow.style.color = '#666';

                    const nextStateInput = document.createElement('input');
                    nextStateInput.className = 'next-state-select';
                    nextStateInput.value = transition.next === 'pause' ? 'pause' : getStateAlias(transition.next) || '';
                    nextStateInput.placeholder = 'next_state_alias';
                    nextStateInput.onclick = (e) => e.stopPropagation(); // Prevent row click
                    nextStateInput.onchange = (e) => updateTransitionProperty(index, tIndex, 'next', e.target.value);

                    // Conditional parameter field (always shown)
                    const conditionalParamInput = document.createElement('input');
                    conditionalParamInput.className = 'optional-input';
                    conditionalParamInput.value = transition.conditional_parameter || '';
                    conditionalParamInput.placeholder = 'conditional_parameter';
                    conditionalParamInput.style.width = '120px';
                    conditionalParamInput.onclick = (e) => e.stopPropagation(); // Prevent row click
                    conditionalParamInput.onchange = (e) => updateTransitionProperty(index, tIndex, 'conditional_parameter', e.target.value);

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-transition';
                    removeBtn.textContent = '‚úï';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation(); // Prevent row click
                        removeTransition(index, tIndex);
                    };

                    transitionDiv.appendChild(conditionSelect);
                    transitionDiv.appendChild(arrow);
                    transitionDiv.appendChild(nextStateInput);
                    transitionDiv.appendChild(document.createTextNode(' param: '));
                    transitionDiv.appendChild(conditionalParamInput);
                    transitionDiv.appendChild(removeBtn);

                    transitionsCell.appendChild(transitionDiv);
                });

                const addTransitionBtn = document.createElement('button');
                addTransitionBtn.className = 'add-transition';
                addTransitionBtn.textContent = '+ Transition';
                addTransitionBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent row click
                    addTransition(index);
                };
                transitionsCell.appendChild(addTransitionBtn);

                row.appendChild(transitionsCell);

                // Actions
                const actionsCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn danger';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeState(index);
                };
                actionsCell.appendChild(deleteBtn);
                row.appendChild(actionsCell);

                tbody.appendChild(row);
            });
        }

        function renderFlowView() {
            const flowView = document.getElementById('flowView');
            flowView.innerHTML = '';

            stateData.states.forEach((state, index) => {
                const node = document.createElement('div');
                node.className = 'flow-node';
                if (editingStateId === state.id) {
                    node.classList.add('editing');
                }

                // Improved click handling
                node.onclick = (e) => handleStateClick(e, state.id);

                const header = document.createElement('div');
                header.className = 'state-header';

                const title = document.createElement('div');
                if (editingStateId === state.id) {
                    // Editable mode
                    const aliasInput = document.createElement('input');
                    aliasInput.className = 'editable';
                    aliasInput.style.background = '#2a2a3a';
                    aliasInput.style.color = '#00ffff';
                    aliasInput.style.width = '100px';
                    aliasInput.value = getStateAlias(state.id);
                    aliasInput.onclick = (e) => e.stopPropagation(); // Prevent node click
                    aliasInput.onchange = (e) => updateStateAlias(index, e.target.value);

                    const actionSelect = document.createElement('select');
                    actionSelect.className = 'action-select';
                    actionSelect.style.background = '#2a2a3a';
                    actionSelect.style.color = '#90ee90';
                    actionTypes.forEach(action => {
                        const option = document.createElement('option');
                        option.value = action;
                        option.textContent = action;
                        if (action === state.action) option.selected = true;
                        actionSelect.appendChild(option);
                    });
                    actionSelect.onclick = (e) => e.stopPropagation(); // Prevent node click
                    actionSelect.onchange = (e) => updateStateProperty(index, 'action', e.target.value);

                    const valueInput = document.createElement('input');
                    valueInput.className = 'value-input';
                    valueInput.style.background = '#2a2a3a';
                    valueInput.value = state.value || '';
                    valueInput.placeholder = 'value';
                    valueInput.onclick = (e) => e.stopPropagation(); // Prevent node click
                    valueInput.onchange = (e) => updateStateProperty(index, 'value', e.target.value);

                    title.appendChild(document.createTextNode('['));
                    title.appendChild(aliasInput);
                    title.appendChild(document.createTextNode('] '));
                    title.appendChild(actionSelect);
                    title.appendChild(document.createTextNode(' ('));
                    title.appendChild(valueInput);
                    title.appendChild(document.createTextNode(')'));
                } else {
                    // Display mode
                    title.innerHTML = `<strong>[${getStateAlias(state.id)}]</strong> ${state.action} <span style="color: #ffa500;">(${state.value || 'no value'})</span>`;
                }

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn danger';
                deleteBtn.textContent = '‚úï';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeState(index);
                };

                header.appendChild(title);
                header.appendChild(deleteBtn);
                node.appendChild(header);

                // Add selectors section
                const selectorsDiv = document.createElement('div');
                selectorsDiv.style.marginBottom = '10px';
                selectorsDiv.innerHTML = '<strong style="color: #ffa500;">Selectors:</strong>';
                
                if (editingStateId === state.id) {
                    // Editable selectors
                    const selectorsTextarea = document.createElement('textarea');
                    selectorsTextarea.className = 'selector-input';
                    selectorsTextarea.style.background = '#2a2a3a';
                    selectorsTextarea.style.width = '100%';
                    selectorsTextarea.style.marginTop = '5px';
                    selectorsTextarea.value = (state.selectors || []).join('\n');
                    selectorsTextarea.rows = 3;
                    selectorsTextarea.placeholder = 'Enter selectors (one per line)';
                    selectorsTextarea.onclick = (e) => e.stopPropagation(); // Prevent node click
                    selectorsTextarea.onchange = (e) => {
                        const selectors = e.target.value.split('\n').filter(s => s.trim());
                        updateStateProperty(index, 'selectors', selectors);
                    };
                    selectorsDiv.appendChild(selectorsTextarea);
                } else {
                    // Display selectors
                    const selectorsList = document.createElement('div');
                    selectorsList.style.fontSize = '11px';
                    selectorsList.style.color = '#ffa500';
                    selectorsList.style.marginTop = '5px';
                    if (state.selectors && state.selectors.length > 0) {
                        state.selectors.forEach(selector => {
                            const selectorSpan = document.createElement('div');
                            selectorSpan.textContent = selector;
                            selectorSpan.style.background = '#1a1a2a';
                            selectorSpan.style.padding = '2px 6px';
                            selectorSpan.style.margin = '2px 0';
                            selectorSpan.style.borderRadius = '3px';
                            selectorsList.appendChild(selectorSpan);
                        });
                    } else {
                        selectorsList.textContent = 'No selectors';
                        selectorsList.style.color = '#666';
                    }
                    selectorsDiv.appendChild(selectorsList);
                }
                
                node.appendChild(selectorsDiv);

                const transitionsDiv = document.createElement('div');
                transitionsDiv.className = 'transitions';
                transitionsDiv.innerHTML = '<strong style="color: #ffff00;">Transitions:</strong>';

                state.transitions.forEach((transition, tIndex) => {
                    const transitionDiv = document.createElement('div');
                    transitionDiv.className = 'transition';

                    if (editingStateId === state.id) {
                        // Editable transition
                        const conditionSelect = document.createElement('select');
                        conditionSelect.className = 'condition-select';
                        conditionSelect.style.background = '#1a1a2a';
                        conditionTypes.forEach(condition => {
                            const option = document.createElement('option');
                            option.value = condition;
                            option.textContent = condition;
                            if (condition === transition.condition) option.selected = true;
                            conditionSelect.appendChild(option);
                        });
                        conditionSelect.onclick = (e) => e.stopPropagation(); // Prevent node click
                        conditionSelect.onchange = (e) => updateTransitionProperty(index, tIndex, 'condition', e.target.value);

                        const nextStateInput = document.createElement('input');
                        nextStateInput.className = 'next-state-select';
                        nextStateInput.style.background = '#1a1a2a';
                        nextStateInput.value = transition.next === 'pause' ? 'pause' : getStateAlias(transition.next) || '';
                        nextStateInput.placeholder = 'next_alias';
                        nextStateInput.onclick = (e) => e.stopPropagation(); // Prevent node click
                        nextStateInput.onchange = (e) => updateTransitionProperty(index, tIndex, 'next', e.target.value);

                        const conditionalParamInput = document.createElement('input');
                        conditionalParamInput.className = 'optional-input';
                        conditionalParamInput.style.background = '#1a1a2a';
                        conditionalParamInput.value = transition.conditional_parameter || '';
                        conditionalParamInput.placeholder = 'param';
                        conditionalParamInput.onclick = (e) => e.stopPropagation(); // Prevent node click
                        conditionalParamInput.onchange = (e) => updateTransitionProperty(index, tIndex, 'conditional_parameter', e.target.value);

                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-transition';
                        removeBtn.textContent = '‚úï';
                        removeBtn.onclick = (e) => {
                            e.stopPropagation();
                            removeTransition(index, tIndex);
                        };

                        transitionDiv.appendChild(conditionSelect);
                        transitionDiv.appendChild(document.createTextNode(' ‚Üí '));
                        transitionDiv.appendChild(nextStateInput);
                        transitionDiv.appendChild(document.createTextNode(' ('));
                        transitionDiv.appendChild(conditionalParamInput);
                        transitionDiv.appendChild(document.createTextNode(')'));
                        transitionDiv.appendChild(removeBtn);
                    } else {
                        // Display mode
                        const conditionIcon = transition.condition === 'always' ? 'üîÑ' :
                            transition.condition === 'element_exists' ? 'üîç' :
                                transition.condition === 'url_matches' ? 'üåê' : '‚ö°';

                        const nextAlias = transition.next === 'pause' ? 'pause' : getStateAlias(transition.next) || 'undefined';
                        const paramText = transition.conditional_parameter ? ` (${transition.conditional_parameter})` : '';
                        transitionDiv.innerHTML = `
                    ${conditionIcon} <strong>${transition.condition}</strong> ‚Üí 
                    <span style="color: #ff69b4;">${nextAlias}</span><span style="color: #ffa500;">${paramText}</span>
                `;
                    }

                    transitionsDiv.appendChild(transitionDiv);
                });

                if (editingStateId === state.id) {
                    const addTransitionBtn = document.createElement('button');
                    addTransitionBtn.className = 'add-transition';
                    addTransitionBtn.textContent = '+ Add Transition';
                    addTransitionBtn.onclick = (e) => {
                        e.stopPropagation();
                        addTransition(index);
                    };
                    transitionsDiv.appendChild(addTransitionBtn);
                }

                node.appendChild(transitionsDiv);
                flowView.appendChild(node);
            });
        }

        // Bot control functions
        async function runBot() {
            if (!stateData.file_name) {
                alert('Please save the bot first before running it.');
                return;
            }
            
            console.log('Starting bot with data:', stateData);
            try {
                const botName = stateData.bot_name || stateData.file_name.replace('.json', '');
                console.log('Using bot name:', botName);
                const result = await window.apiModule.startBotAPI(botName);
                
                if (result.error) {
                    alert(`Error starting bot: ${result.error}`);
                    return;
                }
                
                botStatus = 'running';
                updateBotControlButtons();
                updateStatus(`Bot started successfully! Status: ${result.status || 'running'}`);
            } catch (error) {
                console.error('Error starting bot:', error);
                alert('Failed to start bot. Please check the console for details.');
            }
        }

        async function stopBot() {
            if (!stateData.file_name) return;
            
            try {
                const botName = stateData.bot_name || stateData.file_name.replace('.json', '');
                const result = await window.apiModule.stopBotAPI(botName);
                
                if (result.error) {
                    alert(`Error stopping bot: ${result.error}`);
                    return;
                }
                
                botStatus = 'stopped';
                updateBotControlButtons();
                updateStatus(`Bot stopped successfully! Status: ${result.status || 'stopped'}`);
            } catch (error) {
                console.error('Error stopping bot:', error);
                alert('Failed to stop bot. Please check the console for details.');
            }
        }

        async function pauseBot() {
            if (!stateData.file_name) return;
            
            try {
                const botName = stateData.bot_name || stateData.file_name.replace('.json', '');
                const result = await window.apiModule.pauseBotAPI(botName);
                
                if (result.error) {
                    alert(`Error pausing bot: ${result.error}`);
                    return;
                }
                
                botStatus = 'paused';
                updateBotControlButtons();
                updateStatus(`Bot paused successfully! Status: ${result.status || 'paused'}`);
            } catch (error) {
                console.error('Error pausing bot:', error);
                alert('Failed to pause bot. Please check the console for details.');
            }
        }

        async function resumeBot() {
            if (!stateData.file_name) return;
            
            try {
                const botName = stateData.bot_name || stateData.file_name.replace('.json', '');
                const result = await window.apiModule.resumeBotAPI(botName);
                
                if (result.error) {
                    alert(`Error resuming bot: ${result.error}`);
                    return;
                }
                
                botStatus = 'running';
                updateBotControlButtons();
                updateStatus(`Bot resumed successfully! Status: ${result.status || 'running'}`);
            } catch (error) {
                console.error('Error resuming bot:', error);
                alert('Failed to resume bot. Please check the console for details.');
            }
        }

        function updateBotControlButtons() {
            const runBtn = document.getElementById('runBotBtn');
            const stopBtn = document.getElementById('stopBotBtn');
            const pauseBtn = document.getElementById('pauseBotBtn');
            const resumeBtn = document.getElementById('resumeBotBtn');
            const deleteBtn = document.getElementById('deleteBotBtn');
            
            // Hide all buttons first
            runBtn.style.display = 'none';
            stopBtn.style.display = 'none';
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'none';
            deleteBtn.style.display = 'none';
            
            // Show appropriate buttons based on status
            switch (botStatus) {
                case 'stopped':
                    runBtn.style.display = 'inline-block';
                    deleteBtn.style.display = 'inline-block';
                    break;
                case 'running':
                    stopBtn.style.display = 'inline-block';
                    pauseBtn.style.display = 'inline-block';
                    deleteBtn.style.display = 'inline-block';
                    break;
                case 'paused':
                    stopBtn.style.display = 'inline-block';
                    resumeBtn.style.display = 'inline-block';
                    deleteBtn.style.display = 'inline-block';
                    break;
            }
        }

        async function deleteCurrentBot() {
            if (!stateData.file_name) {
                alert('No bot loaded to delete.');
                return;
            }
            
            if (botStatus !== 'stopped') {
                alert('Please stop the bot before deleting it.');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete the bot "${stateData.bot_name}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const result = await window.apiModule.deleteBot(stateData.file_name);
                
                if (result.error) {
                    alert(`Error deleting bot: ${result.error}`);
                    return;
                }
                
                alert(`Bot "${stateData.bot_name}" deleted successfully!`);
                
                // Return to bot selection screen
                document.getElementById('bot-selection-container').style.display = 'flex';
                document.querySelector('.header').style.display = 'none';
                document.querySelector('.view-tabs').style.display = 'none';
                document.getElementById('tableView').style.display = 'none';
                document.getElementById('status').style.display = 'none';
                
                // Refresh bot list
                loadBots();
                
            } catch (error) {
                console.error('Error deleting bot:', error);
                alert('Failed to delete bot. Please check the console for details.');
            }
        }

        // Clear click counts when clicking outside
        document.addEventListener('click', () => {
            clickCount = {};
        });
    </script>
</body>

</html>